<?xml version="1.0" encoding="UTF-8"?>

<included>
    <include resource="org/springframework/boot/logging/logback/defaults.xml" />
    <property scope="context" name="logHome" value="/var/log/app"/>
    <springProperty scope="context" name="appName" source="spring.application.name"/>
    <springProperty scope="context" name="logHome" source="spring.log.home" defaultValue="/var/log/app/"/>

    <springProfile name="dev,async-text-console-appender">
        <appender name="TEXT_CONSOLE_APPENDER" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="io.anyway.bigbang.framework.logging.XPatternLayoutEncoder">
                <pattern>${CONSOLE_LOG_PATTERN}</pattern>
                <charset>utf8</charset>
            </encoder>
        </appender>
        <appender name="ASYNC_TEXT_CONSOLE_APPENDER" class="io.anyway.bigbang.framework.logging.InheritableThreadAsyncAppender">
            <discardingThreshold>0</discardingThreshold>
            <queueSize>2048</queueSize>
            <appender-ref ref="TEXT_CONSOLE_APPENDER"/>
            <includeCallerData>true</includeCallerData>
        </appender>
        <root level="INFO">
            <appender-ref ref="ASYNC_TEXT_CONSOLE_APPENDER" />
        </root>
    </springProfile>


    <springProfile name="async-json-console-appender">
        <appender name="JSON_CONSOLE_APPENDER" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="io.anyway.bigbang.framework.logging.XLoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp>
                        <fieldName>appTimestamp</fieldName>
                        <timeZone>Asia/Shanghai</timeZone>
                    </timestamp>
                    <pattern >
                        <omitEmptyFields>true</omitEmptyFields>
                        <pattern>
                            {
                            "appName": "${appName}",
                            "level": "%level",
                            "thread": "%thread",
                            "trace": "%X{X-B3-TraceId:-}",
                            "span": "%X{X-B3-SpanId:-}",
                            "caller": "%logger{40}.%method:%line",
                            "message": "%.-5000message",
                            "marker": "#tryJson{%marker}",
                            "stack_trace": "%exception{full}"
                            }
                        </pattern>
                    </pattern>
                </providers>
            </encoder>
        </appender>
        <appender name="ASYNC_JSON_CONSOLE_APPENDER" class="io.anyway.bigbang.framework.logging.InheritableThreadAsyncAppender">
            <discardingThreshold>0</discardingThreshold>
            <queueSize>2048</queueSize>
            <appender-ref ref="JSON_CONSOLE_APPENDER"/>
            <includeCallerData>true</includeCallerData>
        </appender>
        <root level="INFO">
            <appender-ref ref="ASYNC_JSON_CONSOLE_APPENDER" />
        </root>
    </springProfile>


    <springProfile name="async-text-file-appender">
        <appender name="TEXT_FILE_APPENDER" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>${logHome}/app.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.FixedWindowRollingPolicy">
                <fileNamePattern>${logHome}/app.log%i</fileNamePattern>
                <minIndex>1</minIndex>
                <maxIndex>3</maxIndex>
            </rollingPolicy>
            <encoder class="io.anyway.bigbang.framework.logging.XPatternLayoutEncoder">
                <pattern>${CONSOLE_LOG_PATTERN}</pattern>
                <charset>utf8</charset>
            </encoder>
            <triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy">
                <MaxFileSize>10MB</MaxFileSize>
            </triggeringPolicy>
        </appender>
        <appender name="ASYNC_TEXT_FILE_APPENDER" class="io.anyway.bigbang.framework.logging.InheritableThreadAsyncAppender">
            <discardingThreshold>0</discardingThreshold>
            <queueSize>2048</queueSize>
            <appender-ref ref="TEXT_FILE_APPENDER"/>
            <includeCallerData>true</includeCallerData>
        </appender>
        <root level="INFO">
            <appender-ref ref="ASYNC_TEXT_FILE_APPENDER" />
        </root>
    </springProfile>


    <springProfile name="async-json-file-appender">
        <appender name="JSON_FILE_APPENDER" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>${logHome}/app.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.FixedWindowRollingPolicy">
                <fileNamePattern>${logHome}/app.log%i</fileNamePattern>
                <minIndex>1</minIndex>
                <maxIndex>3</maxIndex>
            </rollingPolicy>
            <encoder class="io.anyway.bigbang.framework.logging.XLoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp>
                        <fieldName>appTimestamp</fieldName>
                        <timeZone>Asia/Shanghai</timeZone>
                    </timestamp>
                    <pattern >
                        <omitEmptyFields>true</omitEmptyFields>
                        <pattern>
                            {
                            "appName": "${appName}",
                            "level": "%level",
                            "thread": "%thread",
                            "trace": "%X{X-B3-TraceId:-}",
                            "span": "%X{X-B3-SpanId:-}",
                            "caller": "%logger{40}.%method:%line",
                            "message": "%.-5000message",
                            "marker": "#tryJson{%marker}",
                            "stack_trace": "%exception{full}"
                            }
                        </pattern>
                    </pattern>
                </providers>
            </encoder>
            <triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy">
                <MaxFileSize>10MB</MaxFileSize>
            </triggeringPolicy>
        </appender>
        <appender name="ASYNC_JSON_FILE_APPENDER" class="io.anyway.bigbang.framework.logging.InheritableThreadAsyncAppender">
            <discardingThreshold>0</discardingThreshold>
            <queueSize>2048</queueSize>
            <appender-ref ref="JSON_FILE_APPENDER"/>
            <includeCallerData>true</includeCallerData>
        </appender>
        <root level="INFO">
            <appender-ref ref="ASYNC_JSON_FILE_APPENDER" />
        </root>
    </springProfile>

</included>
